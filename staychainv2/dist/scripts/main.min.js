!function(){"use strict";function e(){t.classList.remove("open"),a.classList.remove("open"),o.classList.remove("open")}function n(){t.classList.toggle("open"),a.classList.toggle("open"),o.classList.toggle("open"),o.classList.add("opened")}var r=document.querySelector.bind(document),o=r(".navdrawer-container"),t=document.body,a=r(".app-bar"),s=r(".menu"),i=r("main");i.addEventListener("click",e),s.addEventListener("click",n),o.addEventListener("click",function(n){("A"===n.target.nodeName||"LI"===n.target.nodeName)&&e()}),angular.module("main",["firebase","ngRoute","main.controllers","main.factories","main.directives","main.filters"]).constant("FIREBASE_URL","https://staychain.firebaseio.com").run(["$rootScope","$firebase","FIREBASE_URL","User","$location",function(e,n,r,o,t){e.currentUser=null,e.$on("$firebaseSimpleLogin:login",function(n,r){var a=o.findByID(r.uid);e.currentUser=r,a.$loaded(function(){e.currentUser.username=a.username,o.signedIn()&&e.currentUser.username&&t.path(e.currentUser.username)})})}]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"../partials/home.html",controller:"HomeCtrl"}).when("/:username",{templateUrl:"../partials/profile.html",controller:"UserHomeCtrl"}).when("/:username/:chain",{templateUrl:"../partials/chain.html",controller:"ChainDetailsCtrl"}).otherwise({redirectTo:"/"})}])}(),angular.module("main.controllers",[]).controller("HomeCtrl",["$rootScope","$scope","User","$location","FormValidator",function(e,n,r,o,t){e.user={},n.formvalidator=t,e.field={chainDescription:""},r.signedIn()&&e.currentUser.username&&o.path(e.currentUser.username),n.userService=r}]).controller("UserHomeCtrl",["$rootScope","$scope","$routeParams","User","Chain",function(e,n,r,o,t){var a=r.username;o.findUser(a),e.breakChain=function(e){t.breakChain(e)},n.showBreak=function(){e.toggleModal("showBreak")},n.canEdit=function(){var n=e.currentUser.username==a;return n},n.userService=o,n.chain=t}]).controller("portalCtrl",["$scope","$rootScope","User","$timeout","Chain",function(e,n,r,o){n.currentUser=null,n.message=null,n.showModal=!1,n.selectModal={},n.selectModal.signUp=!1,n.selectModal.login=!1,n.selectModal.breakchain=!1,e.userService=r,n.login=function(e){n.message="Logging In",r.login(e).then(function(e){n.currentUser=e,n.userName=r.findByID(e.uid),console.log(n.userName),o(function(){n.toggleModal("resetModal")},1e3)},function(e){console.dir(e),n.message=e.code})},n.logout=function(){console.log("signing out"),n.currentUser=null,r.logout()},n.toggleModal=function(e,r,o){n.showModal=!n.showModal,n[e](r,o)},n.showSignUp=function(){n.selectModal.signUp=!n.selectModal.signUp},n.showLogin=function(){n.selectModal.login=!n.selectModal.login},n.showBreak=function(){n.selectModal.breakchain=!n.selectModal.breakchain},n.showLogOut=function(){n.message="Succesfully logged out!",n.logout(),o(function(){n.toggleModal("resetModal")},1e3)},n.showMessage=function(e,r){var r=1e3|r;n.message=e,o(function(){n.toggleModal("resetModal")},r)},n.resetModal=function(){var e;n.message="";for(e in n.selectModal)n.selectModal.hasOwnProperty(e)&&(n.selectModal[e]=!1)}}]).controller("mainCtrl",["$scope","Chain",function(){}]),angular.module("main.factories",[]).factory("Chain",["$firebase","$rootScope","User","FIREBASE_URL",function(e,n,r,o){var t={getChainLength:function(e,n){var r,o=864e5,t=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());if(n)r=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate());else{var a=new Date;r=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())}return Math.floor((r-t)/o)},startChain:function(e){r.signedIn()&&e?t.addFirstChain(e):n.toggleModal("showMessage","Please add a chain description.")},addChain:function(){var e=(n.currentUser.uid,(new Date).toDateString()),r={start:e,end:"",reason:""},o=parseInt(n.goals[0].chains.length,10);n.goals[0].chains[o]=r,n.goals.$save(0)},breakChain:function(e){var r=(n.currentUser.uid,parseInt(n.goals[0].chains.length-1,10)),o=(new Date).toDateString(),a=new Date(n.goals[0].chains[r].start),s=t.getChainLength(a);n.goals[0].chains[r].end=o,n.goals[0].chains[r].reason=e,n.goals[0].record=parseInt(n.goals[0].record),n.goals[0].record<s||(n.goals[0].record=s),t.addChain(),n.showMessage("Breaking Chain..",2e3)},addFirstChain:function(r){var t=n.currentUser.uid,a=(new Date).toDateString(),s=e(new Firebase(o+"/users/"+t+"/goals/0")).$asArray();s.$add({ID:"",record:"",summary:r,chains:[{start:a,end:"",reason:""}]})}};return t}]).factory("User",["$firebase","FIREBASE_URL","$rootScope","$firebaseSimpleLogin",function(e,n,r,o){var t=new Firebase(n+"/users"),a=new Firebase(n),s=o(a),i={create:function(n,r){var o=e(t.child(n.uid)).$asObject(),a=r.username.trim(),s=e(t.child("username").child(a));return o.$loaded(function(){var e={id:n.uid};s.$update(e)}),o.$loaded(function(){o.id=n.uid,o.username=a,o.email=r.email,o.goals=[],o.$priority=n.uid,o.$save()})},findByUsername:function(r){if(r){var o=new Firebase(n+"/users/username/"+r);return console.log("Trying to find user by username"),e(o).$asObject()}},findByID:function(r){if(r){var o=new Firebase(n+"/users/"+r);return console.log("Trying to find user by user by ID"),e(o).$asObject()}},findUser:function(e){var n=i.findByUsername(e);n.$loaded(function(){var e=n.id,o=i.findByID(e),t=i.findUserGoals(e);o.$loaded(function(){r.UserHomeData=o}),t.$loaded(function(){r.goals=t})})},findUserGoals:function(r){return e(new Firebase(n+"/users/"+r+"/goals/0")).$asArray()},register:function(){return s.$createUser(r.user.email,r.user.password)},signedIn:function(){return null!==s.user},login:function(e){return s.$login("password",{email:e.email,password:e.password,rememberMe:!0})},logout:function(){return s.$logout()},registerSuccess:function(e){return r.message="Signing In",console.log(e,r.user),i.create(e,r.user),r.user},errorHandler:function(e){console.dir(e),r.message=e.code},signUp:function(e){e.password||e.email||(r.message="Please fill out form completely"),i.register().then(i.registerSuccess,i.errorHandler).then(function(e){console.log("236"),i.login(e).then(function(){$timeout(function(){r.toggleModal("resetModal")},1e3)},i.errorHandler)})}};return i}]).factory("FormValidator",["User",function(e){var n={checkPassword:function(e,n){n.repeatPassword.$setValidity("match",e.password==e.repeatPassword)},usernameIsAvailable:function(n,r){var o=e.findByUsername(n);o.$loaded(function(e){r.username.$setValidity("available",null==e.id)})},emailRegex:/^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/,usernameRegex:/^[a-zA-Z0-9\-_]{3,10}$/};return n}]),angular.module("main.directives",[]).directive("chainLink",["Chain",function(e){return{restrict:"E",templateUrl:"../partials/chainLink.html",scope:{chains:"=data"},controller:function(n){n.renderChainLinks=function(n){var r,o="",t=new Date(n.start),a=new Date(n.end),s=n.reason;for(0==!n.end.length?r=e.getChainLength(t,a):(r=e.getChainLength(t),1==r&&(o=""));r--;)o+='<span class="chain"></span>';return n.end&&(o+='<span class="chain break"><div class="reason">'+s+"</div></span>"),o}}}}]).directive("focus",["$timeout",function(e){return{restrict:"A",link:function(n,r){e(function(){r[0].focus()},10)}}}]).directive("highScore",["$timeout",function(e){return{restrict:"E",templateUrl:"../partials/highScore.html",scope:{record:"=data"},controller:function(n){n.day=1==n.record?"day":"days",n.highscore=n.record<200?0:200,n.countup=function(){e(function(){n.highscore++,n.highscore<n.record&&n.countup()},10)},n.countup()}}}]).directive("modal",["$timeout",function(){return{restrict:"E",transclude:!0,templateUrl:"../partials/modal.html",scope:{show:"=show",modals:"=modals"},controller:function(e){e.toggleModal=function(n,r,o){e.show=!e.show,e[n](r,o)}}}}]),angular.module("main.filters",[]).filter("sanitize",["$sce",function(e){return function(n){return e.trustAsHtml(n)}}]);