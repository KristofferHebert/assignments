!function(){"use strict";function e(){o.classList.remove("open"),a.classList.remove("open"),r.classList.remove("open")}function n(){o.classList.toggle("open"),a.classList.toggle("open"),r.classList.toggle("open"),r.classList.add("opened")}var t=document.querySelector.bind(document),r=t(".navdrawer-container"),o=document.body,a=t(".app-bar"),s=t(".menu"),i=t("main");i.addEventListener("click",e),s.addEventListener("click",n),r.addEventListener("click",function(n){("A"===n.target.nodeName||"LI"===n.target.nodeName)&&e()}),angular.module("main",["firebase","ngRoute","main.controllers","main.factories","main.directives","main.filters"]).constant("FIREBASE_URL","https://staychain.firebaseio.com").run(["$rootScope","$firebase","FIREBASE_URL","User","Auth","$location",function(e,n,t,r,o,a){e.currentUser=null,e.$on("$firebaseSimpleLogin:login",function(n,t){var s=r.findByID(t.uid);e.currentUser=t,s.$loaded(function(){e.currentUser.username=s.username,o.signedIn&&e.currentUser.username&&a.path(e.currentUser.username)})})}]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"../partials/home.html",controller:"HomeCtrl"}).when("/:username",{templateUrl:"../partials/profile.html",controller:"UserHomeCtrl"}).when("/:username/:chain",{templateUrl:"../partials/chain.html",controller:"ChainDetailsCtrl"}).otherwise({redirectTo:"/"})}])}(),angular.module("main.controllers",[]).controller("HomeCtrl",["$rootScope","$scope","Auth","Chain","$location",function(e,n,t,r,o){e.field={chainDescription:""},t.signedIn()&&e.currentUser.username&&o.path(e.currentUser.username),n.auth=t}]).controller("UserHomeCtrl",["$rootScope","$scope","$routeParams","User","Chain",function(e,n,t,r,o){var a=t.username;r.findUser(a),e.breakChain=function(e){o.breakChain(e)},n.showBreak=function(){e.toggleModal("showBreak")},n.canEdit=function(){var n=e.currentUser.username==a;return n}}]).controller("ChainDetailsCtrl",["$scope",function(){}]).controller("portalCtrl",["$scope","Auth","$rootScope","User","$timeout","Chain",function(e,n,t,r,o,a){function s(n){return t.message="Signing In",console.log(n),r.create(n,e.user),e.user}function i(e){console.dir(e),t.message=e.code}e.originalUser={},e.user={},t.currentUser=null,t.message=null,t.showModal=!1,t.selectModal={},t.selectModal.signUp=!1,t.selectModal.login=!1,t.selectModal.breakchain=!1,e.checkPassword=function(e,n){n.repeatPassword.$setValidity("match",e.password==e.repeatPassword)},t.signUp=function(e){e.password||e.email||(t.message="Please fill out form completely"),n.register(e).then(s,i).then(function(e){console.log("236"),n.login(e).then(function(){console.log("238"),console.log(t.field.chainDescription),a.startChain(t.field.chainDescription),o(function(){t.toggleModal("resetModal")},1e3)},i)})},t.resetForm=function(){e.user=angular.copy(e.originalUser)},t.login=function(e){t.message="Logging In",n.login(e).then(function(e){t.currentUser=e,t.userName=r.findByID(e.uid),console.log(t.userName),o(function(){t.toggleModal("resetModal")},1e3)},function(e){console.dir(e),t.message=e.code})},t.logout=function(){console.log("signing out"),t.currentUser=null,n.logout()},t.toggleModal=function(e,n,r){t.showModal=!t.showModal,t[e](n,r)},t.showSignUp=function(){t.selectModal.signUp=!t.selectModal.signUp},t.showLogin=function(){t.selectModal.login=!t.selectModal.login},t.showBreak=function(){t.selectModal.breakchain=!t.selectModal.breakchain},t.showLogOut=function(){t.message="Succesfully logged out!",t.logout(),o(function(){t.toggleModal("resetModal")},1e3)},t.showMessage=function(e,n){var n=1e3|n;t.message=e,o(function(){t.toggleModal("resetModal")},n)},t.resetModal=function(){var e;t.message="";for(e in t.selectModal)t.selectModal.hasOwnProperty(e)&&(t.selectModal[e]=!1)}}]).controller("mainCtrl",["$scope","Auth","Chain",function(){}]),angular.module("main.factories",[]).factory("Auth",function(e,n,t){var r=new Firebase(t),o=e(r),a={};return a.register=function(e){return o.$createUser(e.email,e.password)},a.signedIn=function(){return null!==o.user},a.login=function(e){return o.$login("password",e)},a.logout=function(){return o.$logout()},n.signIn=function(){return a.signedIn()},a}).factory("Chain",["$firebase","$rootScope","User","Auth","FIREBASE_URL",function(e,n,t,r,o){var a={getChainLength:function(e,n){var t,r=864e5,o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());if(n)t=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate());else{var a=new Date;t=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate())}return Math.floor((t-o)/r)},startChain:function(e){n.signIn()&&e?a.addFirstChain(e):n.toggleModal("showMessage","Please add a chain description.")},addChain:function(){var e=(n.currentUser.uid,(new Date).toDateString()),t={start:e,end:"",reason:""},r=parseInt(n.goals[0].chains.length,10);n.goals[0].chains[r]=t,n.goals.$save(0)},breakChain:function(e){var t=(n.currentUser.uid,parseInt(n.goals[0].chains.length-1,10)),r=(new Date).toDateString(),o=new Date(n.goals[0].chains[t].start),s=a.getChainLength(o);n.goals[0].chains[t].end=r,n.goals[0].chains[t].reason=e,n.goals[0].record=parseInt(n.goals[0].record),n.goals[0].record<s||(n.goals[0].record=s),a.addChain(),n.showMessage("Breaking Chain..",2e3)},addFirstChain:function(t){var r=n.currentUser.uid,a=(new Date).toDateString(),s=e(new Firebase(o+"/users/"+r+"/goals/0")).$asArray();s.$add({ID:"",record:"",summary:t,chains:[{start:a,end:"",reason:""}]})}};return a}]).factory("User",function(e,n,t,r){var o=new Firebase(n+"/users"),a={create:function(n,t){var r=e(o.child(n.uid)).$asObject(),a=e(o.child("username").child(t.username));return r.$loaded(function(){var e={id:n.uid};a.$update(e)}),r.$loaded(function(){r.id=n.uid,r.username=t.username,r.email=t.email,r.goals=[],r.md5_hash=n.md5_hash,r.$priority=n.uid,r.$save()})},findByUsername:function(t){if(t){var r=new Firebase(n+"/users/username/"+t);return console.log("Trying to find user by username"),e(r).$asObject()}},findByID:function(t){if(t){var r=new Firebase(n+"/users/"+t);return console.log("Trying to find user by user by ID"),e(r).$asObject()}},findUser:function(e){var n=a.findByUsername(e);n.$loaded(function(){var e=n.id,t=a.findByID(e),o=a.findUserGoals(e);t.$loaded(function(){r.UserHomeData=t}),o.$loaded(function(){r.goals=o})})},findUserGoals:function(t){return e(new Firebase(n+"/users/"+t+"/goals/0")).$asArray()}};return a}),angular.module("main.directives",[]).directive("chainLink",["Chain",function(e){return{restrict:"E",templateUrl:"../partials/chainLink.html",scope:{chains:"=data"},controller:function(n){n.getChainLength=e.getChainLength,n.renderChainLinks=function(e){var t,r="",o=new Date(e.start),a=new Date(e.end);for(0==!e.end.length?t=n.getChainLength(o,a):(t=n.getChainLength(o),0===t&&(r="You just started, checkback tomorrow to see your chain grow!"));t--;)r+='<span class="chain"></span>';return e.end&&(r+='<span class="chain break"></span>'),r}}}}]).directive("focus",["$timeout",function(e){return{restrict:"A",link:function(n,t){e(function(){t[0].focus()},10)}}}]),angular.module("main.filters",[]).filter("sanitize",["$sce",function(e){return function(n){return e.trustAsHtml(n)}}]);